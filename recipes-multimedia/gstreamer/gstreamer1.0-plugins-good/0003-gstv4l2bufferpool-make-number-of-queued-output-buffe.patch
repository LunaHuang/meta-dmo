From: Michael Olbrich <m.olbrich@pengutronix.de>
Date: Mon, 14 May 2012 16:44:07 +0200
Subject: [PATCH] gstv4l2bufferpool: make number of queued output buffers
 configurable for USERPTR

Signed-off-by: Michael Olbrich <m.olbrich@pengutronix.de>
---
 sys/v4l2/gstv4l2bufferpool.c |  2 +-
 sys/v4l2/gstv4l2object.c     | 14 ++++++++++++++
 sys/v4l2/gstv4l2object.h     |  2 ++
 3 files changed, 17 insertions(+), 1 deletion(-)

diff --git a/sys/v4l2/gstv4l2bufferpool.c b/sys/v4l2/gstv4l2bufferpool.c
index 5859fc5..648217a 100644
--- a/sys/v4l2/gstv4l2bufferpool.c
+++ b/sys/v4l2/gstv4l2bufferpool.c
@@ -1433,7 +1433,7 @@ gst_v4l2_buffer_pool_process (GstV4l2BufferPool * pool, GstBuffer * buf)
             if (!start_streaming (pool))
               goto start_failed;
 
-          if (pool->num_queued > 1) {
+          if (pool->num_queued > pool->obj->min_queued) {
             /* >1 buffer are queued, try to dequeue one and release it back
              * into the pool so that _acquire can get to it again. */
             ret = gst_v4l2_buffer_pool_dqbuf (pool, &buf);
diff --git a/sys/v4l2/gstv4l2object.c b/sys/v4l2/gstv4l2object.c
index 1e0416c..dbd1676 100644
--- a/sys/v4l2/gstv4l2object.c
+++ b/sys/v4l2/gstv4l2object.c
@@ -62,6 +62,7 @@ GST_DEBUG_CATEGORY_EXTERN (GST_CAT_PERFORMANCE);
 #define DEFAULT_PROP_DEVICE_NAME 	NULL
 #define DEFAULT_PROP_DEVICE_FD          -1
 #define DEFAULT_PROP_FLAGS              0
+#define DEFAULT_PROP_MIN_QUEUED         1
 #define DEFAULT_PROP_TV_NORM            0
 #define DEFAULT_PROP_CHANNEL            NULL
 #define DEFAULT_PROP_FREQUENCY          0
@@ -421,6 +422,11 @@ gst_v4l2_object_install_properties_helper (GObjectClass * gobject_class,
           GST_TYPE_V4L2_DEVICE_FLAGS, DEFAULT_PROP_FLAGS,
           G_PARAM_READABLE | G_PARAM_STATIC_STRINGS));
 
+  g_object_class_install_property (gobject_class, PROP_MIN_QUEUED,
+      g_param_spec_int ("min-queued", "min queued",
+          "minimum number of queued v4l2 buffers", 0,
+          G_MAXINT, DEFAULT_PROP_MIN_QUEUED,
+          G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
   /**
    * GstV4l2Src:brightness
    *
@@ -564,6 +570,8 @@ gst_v4l2_object_new (GstElement * element,
   v4l2object->active = FALSE;
   v4l2object->videodev = g_strdup (default_device);
 
+  v4l2object->min_queued = DEFAULT_PROP_MIN_QUEUED;
+
   v4l2object->norms = NULL;
   v4l2object->channels = NULL;
   v4l2object->colors = NULL;
@@ -648,6 +656,9 @@ gst_v4l2_object_set_property_helper (GstV4l2Object * v4l2object,
       g_free (v4l2object->videodev);
       v4l2object->videodev = g_value_dup_string (value);
       break;
+    case PROP_MIN_QUEUED:
+      v4l2object->min_queued = g_value_get_int (value);
+      break;
     case PROP_BRIGHTNESS:
     case PROP_CONTRAST:
     case PROP_SATURATION:
@@ -782,6 +793,9 @@ gst_v4l2_object_get_property_helper (GstV4l2Object * v4l2object,
       g_value_set_flags (value, flags);
       break;
     }
+    case PROP_MIN_QUEUED:
+      g_value_set_int (value, v4l2object->min_queued);
+      break;
     case PROP_BRIGHTNESS:
     case PROP_CONTRAST:
     case PROP_SATURATION:
diff --git a/sys/v4l2/gstv4l2object.h b/sys/v4l2/gstv4l2object.h
index d478b35..9718753 100644
--- a/sys/v4l2/gstv4l2object.h
+++ b/sys/v4l2/gstv4l2object.h
@@ -111,6 +111,7 @@ struct _GstV4l2Object {
   GstV4l2IOMode mode;
   GstPoll * poll;
   gboolean can_poll_device;
+  gint min_queued;
 
   gboolean active;
   gboolean streaming;
@@ -177,6 +178,7 @@ GType gst_v4l2_object_get_type (void);
     PROP_DEVICE_NAME,			\
     PROP_DEVICE_FD,			\
     PROP_FLAGS,                         \
+    PROP_MIN_QUEUED,                    \
     PROP_BRIGHTNESS,			\
     PROP_CONTRAST,			\
     PROP_SATURATION,			\
